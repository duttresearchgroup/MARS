<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Application Heartbeats: lat.c</title>
<img src="img/hb.png" height="100" border="0" alt="Hearbeats"></a>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.6 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="classes.html"><span>Data&nbsp;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>lat.c</h1>Latency Example<p>
<div class="fragment"><pre class="fragment">
<span class="preprocessor">#include &lt;stdio.h&gt;</span>
<span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<span class="preprocessor">#include &lt;string.h&gt;</span>
<span class="preprocessor">#include &lt;unistd.h&gt;</span>
<span class="preprocessor">#include &lt;sys/wait.h&gt;</span>
<span class="preprocessor">#include "<a class="code" href="heartbeat_8h.html">heartbeat.h</a>"</span>
<span class="preprocessor">#include "<a class="code" href="heart__rate__monitor_8h.html">heart_rate_monitor.h</a>"</span>

<a name="_a0"></a><a class="code" href="structheartbeat__t.html">heartbeat_t</a> <a name="a1"></a><a class="code" href="application_8c.html#6f3bbe24b9b561560ce8bf9208aeb8a7">heart</a>;
<a name="_a2"></a><a class="code" href="structheart__rate__monitor__t.html">heart_rate_monitor_t</a> <a name="a3"></a><a class="code" href="lat_8c.html#f6999b2aa30c479bbb16f354ff38c1e5">hrm</a>;

<span class="keywordtype">int</span> <a name="a4"></a><a class="code" href="core-allocator_8c.html#718ec6ec56d322c1c0c70fdc0e4bde73">get_heartbeat_apps</a>(<span class="keywordtype">int</span>* apps) {

   pid_t pid;
   <span class="keywordtype">int</span> rv;
   <span class="keywordtype">int</span>  commpipe[2];            <span class="comment">/* This holds the fd for the input &amp; output of the pipe */</span>
   <span class="keywordtype">char</span> <span class="keywordtype">string</span>[1024][100];
   <span class="keywordtype">int</span> count = 0;
  
   <span class="comment">/* Setup communication pipeline first */</span>
   <span class="keywordflow">if</span>(pipe(commpipe)){
      fprintf(stderr,<span class="stringliteral">"Pipe error!\n"</span>);
      exit(1);
   }
  
   <span class="comment">/* Attempt to fork and check for errors */</span>
   <span class="keywordflow">if</span>( (pid=fork()) &lt; 0 ){
      fprintf(stderr,<span class="stringliteral">"Fork error. Exiting.\n"</span>);  <span class="comment">/* something went wrong */</span>
      exit(1);        
   }
  
   <span class="keywordflow">if</span>(pid){
      <span class="comment">/* A positive (non-negative) PID indicates the parent process */</span>
      dup2(commpipe[0],0);      
      close(commpipe[1]);               
      <span class="keywordflow">while</span>(fgets(<span class="keywordtype">string</span>[count], 100, stdin)) {
         apps[count] = atoi(<span class="keywordtype">string</span>[count]);
         count++;
      }
    
      <span class="comment">//printf("From the system: found %d apps\n", count);</span>
      <span class="comment">//printf("From the system: app is %d\n", apps[0]);</span>
      <span class="comment">//wait(&amp;rv);                              /* Wait for child process to end */</span>
      wait(&amp;rv);
      <span class="comment">//fprintf(stderr,"Child exited with a %d value\n",rv);</span>
   }
   <span class="keywordflow">else</span>{
      <span class="comment">/* A zero PID indicates that this is the child process */</span>
      dup2(commpipe[1],1);      <span class="comment">/* Replace stdout with the out side of the pipe */</span>
      close(commpipe[0]);               <span class="comment">/* Close unused side of pipe (in side) */</span>
      <span class="comment">/* Replace the child fork with a new process */</span>
      <span class="comment">//FIXME</span>
      <span class="comment">//if(execl("/bin/ls","/bin/ls","/scratch/etc/heartbeat/heartbeat-enabled-apps/",(char*) NULL) == -1){</span>
      <span class="keywordflow">if</span>(execl(<span class="stringliteral">"/bin/ls"</span>,<span class="stringliteral">"/bin/ls"</span>,getenv(<span class="stringliteral">"HEARTBEAT_ENABLED_DIR"</span>),(<span class="keywordtype">char</span>*) NULL) == -1){
         fprintf(stderr,<span class="stringliteral">"execl Error!"</span>);
         exit(1);
      }
   }

   close(commpipe[0]);
   <span class="keywordflow">return</span> count;
}

<span class="keywordtype">void</span> <a name="a5"></a><a class="code" href="lat_8c.html#cda850128deec11e104b408bae870f3c">app</a>(<span class="keywordtype">char</span>* logname, <span class="keywordtype">int</span> iters)
{
  <a name="_a6"></a><a class="code" href="structheartbeat__record__t.html">heartbeat_record_t</a> record;
   <span class="comment">// init heartbeats and a monitor</span>
   <span class="comment">//printf("executing the app code\n");</span>
   <a name="a7"></a><a class="code" href="heartbeat-file_8c.html#b0215f451a25327778cf2469bbf17808">heartbeat_init</a>(&amp;heart, 0, 1000000, 10, 100, NULL);
   <span class="keywordtype">int</span> apps[2];
   <span class="keywordflow">while</span>( <a class="code" href="core-allocator_8c.html#718ec6ec56d322c1c0c70fdc0e4bde73">get_heartbeat_apps</a>(apps) != 2 );   
   <span class="keywordtype">int</span> pid = getpid();
   <span class="keywordflow">if</span> ( apps[0] == pid )
      <a name="a8"></a><a class="code" href="heart__rate__monitor-file_8c.html#d49db9e81266e365b06d5c818d7e5b63">heart_rate_monitor_init</a>(&amp;hrm, apps[1]);
   <span class="keywordflow">else</span>
      <a class="code" href="heart__rate__monitor-file_8c.html#d49db9e81266e365b06d5c818d7e5b63">heart_rate_monitor_init</a>(&amp;hrm, apps[0]);

   <span class="comment">// quiesce for a bit then synchronize</span>
   usleep(1000000);
   
   <a name="a9"></a><a class="code" href="heartbeat-file_8c.html#83cee6dbfb8365b1595ef200f45fe6fc">heartbeat</a>(&amp;heart, -2); 
   
   <span class="keywordtype">int</span> tag;
   <span class="keywordflow">do</span> 
   {
      <span class="keywordtype">int</span> rc = -1;
      <span class="keywordflow">while</span> (rc != 0)
       rc = <a name="a10"></a><a class="code" href="heart__rate__monitor-file_8c.html#333f4dfca799e511a797559107dea290">hrm_get_current</a>(&amp;hrm, &amp;record);
      tag = record.<a name="a11"></a><a class="code" href="structheartbeat__record__t.html#77ac9f7644a849d9d33905b94bca72be">tag</a>;
   } <span class="keywordflow">while</span>( tag != -1 );


   <span class="comment">// no timer code needed here</span>
   <span class="keywordtype">int</span> i;
   <span class="keywordflow">for</span>(i = iters; i &gt; 0; i--) {

      <span class="comment">// issue a heartbeat</span>
     <a class="code" href="heartbeat-file_8c.html#83cee6dbfb8365b1595ef200f45fe6fc">heartbeat</a>(&amp;heart, i);
     
     <span class="comment">// wait for a heartbeat</span>
     <span class="keywordflow">do</span> 
       {
         <span class="keywordtype">int</span> rc = -1;
         <span class="keywordflow">while</span> (rc != 0)
           rc = <a class="code" href="heart__rate__monitor-file_8c.html#333f4dfca799e511a797559107dea290">hrm_get_current</a>(&amp;hrm, &amp;record);
         tag = record.<a class="code" href="structheartbeat__record__t.html#77ac9f7644a849d9d33905b94bca72be">tag</a>;
        
       } <span class="keywordflow">while</span>( tag != (iters - i) );
   }  
      <a name="a12"></a><a class="code" href="heartbeat-file_8c.html#472683cf2037492695c74b37944efca9">heartbeat_finish</a>(&amp;heart);

   <span class="comment">// no timer code needed here</span>
}

<span class="keywordtype">void</span> <a name="a13"></a><a class="code" href="lat_8c.html#826197580f9363339f3b25e47c74976e">sys</a>(<span class="keywordtype">char</span>* logname, <span class="keywordtype">int</span> iters)
{
  <a class="code" href="structheartbeat__record__t.html">heartbeat_record_t</a> record;
   <span class="comment">// init heartbeats and a monitor</span>
  <a class="code" href="heartbeat-file_8c.html#b0215f451a25327778cf2469bbf17808">heartbeat_init</a>(&amp;heart, 0, 1000000, 10, 100, NULL);
  <span class="keywordtype">int</span> apps[2];
  <span class="keywordflow">while</span>( <a class="code" href="core-allocator_8c.html#718ec6ec56d322c1c0c70fdc0e4bde73">get_heartbeat_apps</a>(apps) != 2 );   
  <span class="keywordtype">int</span> pid = getpid();
  <span class="keywordflow">if</span> ( apps[0] == pid )
    <a class="code" href="heart__rate__monitor-file_8c.html#d49db9e81266e365b06d5c818d7e5b63">heart_rate_monitor_init</a>(&amp;hrm, apps[1]);
  <span class="keywordflow">else</span>
    <a class="code" href="heart__rate__monitor-file_8c.html#d49db9e81266e365b06d5c818d7e5b63">heart_rate_monitor_init</a>(&amp;hrm, apps[0]);
  
  <span class="comment">// quiesce for a bit then synchronize</span>
  usleep(1000000);
  <span class="keywordtype">int</span> tag;
  <span class="keywordflow">do</span> 
    {
      <span class="keywordtype">int</span> rc = -1;
      <span class="keywordflow">while</span> (rc != 0)
        rc = <a class="code" href="heart__rate__monitor-file_8c.html#333f4dfca799e511a797559107dea290">hrm_get_current</a>(&amp;hrm, &amp;record);
      tag = record.<a class="code" href="structheartbeat__record__t.html#77ac9f7644a849d9d33905b94bca72be">tag</a>;
    } <span class="keywordflow">while</span>( tag != -2 );
  <a class="code" href="heartbeat-file_8c.html#83cee6dbfb8365b1595ef200f45fe6fc">heartbeat</a>(&amp;heart, -1);   
  
  <span class="comment">// start timer</span>
  <span class="keyword">struct </span>timespec time_info;
  int64_t time1, time2;
   clock_gettime( CLOCK_REALTIME, &amp;time_info );
   time1 = ( (int64_t) time_info.tv_sec * 1000000000 + (int64_t) time_info.tv_nsec );
   
   <span class="keywordtype">int</span> i;
   <span class="keywordflow">for</span>(i = 0; i &lt; iters; i++) {
     
     <span class="comment">// wait for a heartbeat</span>
     <span class="keywordflow">do</span> 
       {
         <span class="keywordtype">int</span> rc = -1;
         <span class="keywordflow">while</span> (rc != 0)
           rc = <a class="code" href="heart__rate__monitor-file_8c.html#333f4dfca799e511a797559107dea290">hrm_get_current</a>(&amp;hrm, &amp;record);
         tag = record.<a class="code" href="structheartbeat__record__t.html#77ac9f7644a849d9d33905b94bca72be">tag</a>;
       } <span class="keywordflow">while</span>( tag != (iters - i) );

     <span class="comment">// issue a heartbeat</span>
     <a class="code" href="heartbeat-file_8c.html#83cee6dbfb8365b1595ef200f45fe6fc">heartbeat</a>(&amp;heart, i);
   }   
   
   <span class="comment">// end timer</span>
   clock_gettime( CLOCK_REALTIME, &amp;time_info );
   time2 = ( (int64_t) time_info.tv_sec * 1000000000 + (int64_t) time_info.tv_nsec );

   <span class="comment">// latency calculation in units of ns</span>
   <span class="keywordtype">double</span> latency = ((double) (time2 - time1)) / ((<span class="keywordtype">double</span>) (iters * 2)) ;
   printf(<span class="stringliteral">"average heartbeats latency: %0.2f ns\n"</span>, latency);
   printf(<span class="stringliteral">"  = %.0f cycles @ 3.16 GHz\n"</span>, 3.16 * latency );
   <a class="code" href="heartbeat-file_8c.html#472683cf2037492695c74b37944efca9">heartbeat_finish</a>(&amp;heart);
  
}

<span class="keywordtype">int</span> <a name="a14"></a><a class="code" href="application_8c.html#3c04138a5bfe5d72780bb7e82a18e627" title="compile with define NOSLEEP for none">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>** argv) {
   <span class="keywordflow">if</span> ( argc != 3 )
   {
      printf(<span class="stringliteral">"usage:\n"</span>);
      printf(<span class="stringliteral">"  application num_beats, log_file\n"</span>);
      <span class="keywordflow">return</span> -1;
   }
   <span class="keywordflow">if</span>(getenv(<span class="stringliteral">"HEARTBEAT_ENABLED_DIR"</span>) == NULL) {
     fprintf(stderr, <span class="stringliteral">"ERROR: need to define environment variable HEARTBEAT_ENABLED_DIR (see README)\n"</span>);
     <span class="keywordflow">return</span> 1;
   }

   <span class="comment">// fork a process. </span>
   <span class="comment">// this process models the application (and does cleanup)</span>
   <span class="comment">// the child process models the system </span>

   <span class="keywordtype">int</span> rv;
   pid_t pid = fork();

   <span class="keywordflow">if</span>( pid &lt; 0 ){
      fprintf(stderr,<span class="stringliteral">"Fork error. Exiting.\n"</span>);  <span class="comment">/* something went wrong */</span>
      exit(1);        
   }

   <span class="keywordflow">if</span> ( pid == 0 )
   {
      <a class="code" href="lat_8c.html#826197580f9363339f3b25e47c74976e">sys</a>( argv[2], atoi(argv[1]) );
      <span class="keywordflow">return</span> 0;
   }
   <span class="keywordflow">else</span>
   {
      <a class="code" href="lat_8c.html#cda850128deec11e104b408bae870f3c">app</a>( argv[2], atoi(argv[1]) );
      wait(&amp;rv);

      <span class="comment">// cleanup</span>
      <span class="keywordflow">return</span> 0;
   }
   <span class="keywordflow">return</span> 0;
}
</pre></div> </div>
<hr size="1"><address style="text-align: right;"><small>Generated on Wed Feb 10 12:43:50 2010 for Application Heartbeats by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.6 </small></address>
</body>
</html>
